<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FAFAF9; /* Stone 50 */
            color: #1C1917; /* Stone 900 */
        }

        /* Minimalist Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #E7E5E4;
            border-radius: 3px;
        }

        .notification-toast {
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            backdrop-filter: blur(8px);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .btn-primary {
            background-color: #1C1917;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #44403C;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: white;
            color: #1C1917;
            border: 1px solid #E7E5E4;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            border-color: #A8A29E;
            background-color: #FAFAF9;
        }

        .input-field {
            background-color: white;
            border: 1px solid #E7E5E4;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #1C1917;
            outline: none;
            box-shadow: 0 0 0 1px #1C1917;
        }

        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col">
    <!-- Navbar -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-stone-200 sticky top-0 z-30">
        <div class="max-w-6xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i data-lucide="book-open" class="w-6 h-6 text-stone-800"></i>
                <span class="text-lg font-semibold tracking-tight text-stone-900">Learning<span class="font-light text-stone-500">Community</span></span>
            </div>
            
            <div class="flex items-center gap-6">
                <div id="userInfo" class="hidden items-center gap-6">
                    <div class="flex items-center gap-2 text-sm font-medium text-stone-600">
                        <i data-lucide="user" class="w-4 h-4"></i>
                        <span id="userName">User</span>
                    </div>
                    <div class="flex items-center gap-2 text-xs">
                        <span id="wsStatusDot" class="w-2 h-2 rounded-full bg-stone-300"></span>
                        <span id="wsStatusText" class="text-stone-400">Disconnected</span>
                    </div>
                    <button onclick="logout()" class="text-stone-400 hover:text-red-500 transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div id="authButtons" class="flex items-center gap-4">
                    <button onclick="showModal('loginModal')" class="text-sm font-medium text-stone-600 hover:text-stone-900 transition-colors">Log in</button>
                    <button onclick="showModal('registerModal')" class="btn-primary px-5 py-2.5 rounded-full text-sm font-medium">Sign up</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-6xl mx-auto px-6 py-12 w-full">
        <!-- Tabs -->
        <div class="flex justify-center mb-12">
            <div class="inline-flex bg-stone-100 p-1.5 rounded-2xl gap-1">
                <button onclick="switchTab('questions')" id="tab-questions" class="px-6 py-2.5 rounded-xl text-sm font-medium transition-all shadow-sm bg-white text-stone-900">
                    Discussions
                </button>
                <button onclick="switchTab('search')" id="tab-search" class="px-6 py-2.5 rounded-xl text-sm font-medium transition-all text-stone-500 hover:text-stone-900">
                    Search
                </button>
                <button onclick="switchTab('admin')" id="tab-admin" class="hidden px-6 py-2.5 rounded-xl text-sm font-medium transition-all text-stone-500 hover:text-stone-900">
                    Admin
                </button>
            </div>
        </div>

        <!-- Questions Page -->
        <div id="page-questions" class="page max-w-4xl mx-auto fade-in">
            <div class="flex justify-between items-end mb-10">
                <div>
                    <h1 class="text-3xl font-light text-stone-900 mb-2">Latest Discussions</h1>
                    <p class="text-stone-500 font-light">Join the conversation and share your knowledge.</p>
                </div>
                <button onclick="showModal('askModal')" class="btn-primary px-6 py-3 rounded-full flex items-center gap-2 shadow-lg shadow-stone-200">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span>New Question</span>
                </button>
            </div>

            <div id="questionList" class="grid gap-6">
                <!-- Question items will be injected here -->
                <div class="text-center py-20 text-stone-400 font-light">Loading discussions...</div>
            </div>
        </div>

        <!-- Search Page -->
        <div id="page-search" class="page max-w-4xl mx-auto hidden fade-in">
            <div class="text-center mb-12">
                <h1 class="text-3xl font-light text-stone-900 mb-4">Explore Topics</h1>
                <div class="relative max-w-2xl mx-auto">
                    <input type="text" id="searchInput" placeholder="What are you looking for?" 
                        class="w-full pl-12 pr-6 py-4 rounded-2xl border-none bg-white shadow-sm text-lg focus:ring-2 focus:ring-stone-100 placeholder-stone-400">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-stone-400"></i>
                </div>
            </div>
            <div id="searchResults" class="grid gap-6">
                <div class="text-center py-12 text-stone-400 font-light">Type to start searching</div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="page-admin" class="page max-w-6xl mx-auto hidden fade-in">
            <h1 class="text-3xl font-light text-stone-900 mb-10">Content Moderation</h1>
            
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Pending Questions -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-orange-600">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                        </div>
                        <h2 class="text-xl font-medium text-stone-900">Pending Questions</h2>
                    </div>
                    <div id="pendingQuestions" class="space-y-4">
                        <div class="text-stone-400 text-sm font-light italic">No pending questions</div>
                    </div>
                </div>

                <!-- Pending Answers -->
                <div class="bg-white rounded-3xl p-8 shadow-sm border border-stone-100">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                            <i data-lucide="message-circle" class="w-5 h-5"></i>
                        </div>
                        <h2 class="text-xl font-medium text-stone-900">Pending Answers</h2>
                    </div>
                    <div id="pendingAnswers" class="space-y-4">
                        <div class="text-stone-400 text-sm font-light italic">No pending answers</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-24 right-6 space-y-4 z-50 pointer-events-none"></div>

    <!-- Modals -->
    <!-- Modal Overlay -->
    <div id="modalOverlay" class="fixed inset-0 bg-stone-900/20 backdrop-blur-sm hidden z-40 transition-opacity opacity-0" onclick="closeAllModals()"></div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-3xl p-8 shadow-2xl z-50 hidden opacity-0 transition-all scale-95">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-light text-stone-900">Welcome Back</h3>
            <button onclick="hideModal('loginModal')" class="text-stone-400 hover:text-stone-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <form onsubmit="login(event)" class="space-y-6">
            <div>
                <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2">Email Address</label>
                <input type="email" id="loginEmail" required class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300">
            </div>
            <div>
                <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2">Password</label>
                <input type="password" id="loginPassword" required class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300">
            </div>
            <button type="submit" class="btn-primary w-full py-3.5 rounded-xl font-medium">Log In</button>
        </form>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white rounded-3xl p-8 shadow-2xl z-50 hidden opacity-0 transition-all scale-95">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-light text-stone-900">Create Account</h3>
            <button onclick="hideModal('registerModal')" class="text-stone-400 hover:text-stone-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <form onsubmit="register(event)" class="space-y-6">
            <div>
                <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2">Nickname</label>
                <input type="text" id="registerNickname" required class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300">
            </div>
            <div>
                <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2">Email Address</label>
                <input type="email" id="registerEmail" required class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300">
            </div>
            <div>
                <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2">Password</label>
                <input type="password" id="registerPassword" required class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300">
            </div>
            <button type="submit" class="btn-primary w-full py-3.5 rounded-xl font-medium">Sign Up</button>
        </form>
    </div>

    <!-- Ask Modal -->
    <div id="askModal" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl bg-white rounded-3xl p-10 shadow-2xl z-50 hidden opacity-0 transition-all scale-95">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-light text-stone-900">Start a Discussion</h3>
            <button onclick="hideModal('askModal')" class="text-stone-400 hover:text-stone-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <form onsubmit="submitQuestion(event)" class="space-y-6">
            <div>
                <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2">Title</label>
                <input type="text" id="questionTitle" required placeholder="What's on your mind?" 
                    class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300 text-lg">
            </div>
            <div>
                <label class="block text-xs font-semibold text-stone-500 uppercase tracking-wider mb-2">Details</label>
                <textarea id="questionContent" rows="6" required placeholder="Describe your question in detail..." 
                    class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300 resize-none"></textarea>
            </div>
            <div class="flex justify-end gap-3 pt-2">
                <button type="button" onclick="hideModal('askModal')" class="btn-secondary px-6 py-3 rounded-xl font-medium">Cancel</button>
                <button type="submit" class="btn-primary px-8 py-3 rounded-xl font-medium">Publish</button>
            </div>
        </form>
    </div>

    <!-- Question Detail Modal -->
    <div id="questionDetailModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="fixed inset-0 bg-stone-900/20 backdrop-blur-sm" onclick="hideModal('questionDetailModal')"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-3xl rounded-3xl shadow-2xl p-10 relative">
                <button onclick="hideModal('questionDetailModal')" class="absolute top-6 right-6 text-stone-400 hover:text-stone-600 p-2">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <div class="mb-10">
                    <h2 id="detailTitle" class="text-2xl font-medium text-stone-900 mb-4 leading-snug"></h2>
                    <p id="detailContent" class="text-stone-600 leading-relaxed text-lg font-light"></p>
                    <div id="detailAdminActions" class="hidden mt-6">
                        <button onclick="deleteCurrentQuestion()" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Delete
                        </button>
                    </div>
                </div>

                <div class="border-t border-stone-100 pt-8">
                    <div class="flex justify-between items-center mb-8">
                        <h4 class="text-lg font-medium text-stone-900 flex items-center gap-2">
                            <i data-lucide="message-square" class="w-5 h-5 text-stone-400"></i>
                            Responses
                        </h4>
                        <button onclick="showAnswerModal()" class="text-stone-900 hover:text-stone-600 text-sm font-medium underline underline-offset-4 decoration-stone-300">
                            Write a response
                        </button>
                    </div>
                    <div id="answerList" class="space-y-6">
                        <!-- Answers injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Answer Modal -->
    <div id="answerModal" class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-xl bg-white rounded-3xl p-8 shadow-2xl z-50 hidden opacity-0 transition-all scale-95">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-medium text-stone-900">Your Response</h3>
            <button onclick="hideModal('answerModal')" class="text-stone-400 hover:text-stone-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <form onsubmit="submitAnswer(event)">
            <input type="hidden" id="answerQuestionId">
            <div class="mb-6">
                <textarea id="answerContent" rows="5" required placeholder="Share your thoughts..." 
                    class="input-field w-full px-4 py-3 rounded-xl text-stone-900 placeholder-stone-300 resize-none"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="hideModal('answerModal')" class="btn-secondary px-6 py-2.5 rounded-xl font-medium">Cancel</button>
                <button type="submit" class="btn-primary px-8 py-2.5 rounded-xl font-medium">Post Response</button>
            </div>
        </form>
    </div>

    <script>
        // --- Initialization & Icons ---
        lucide.createIcons();
        const API_BASE = 'http://localhost:8081';
        let currentUser = null;
        let ws = null;
        let currentQuestionId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadQuestions();
            checkAuth();
            lucide.createIcons();
            
            // Search Input Listener
            const searchInput = document.getElementById('searchInput');
            if(searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchQuestions();
                });
            }
        });

        function refreshIcons() {
            setTimeout(() => lucide.createIcons(), 0);
        }

        // --- Auth & WebSocket ---
        function checkAuth() {
            const userData = localStorage.getItem('user');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateUIForLoggedIn();
                connectWebSocket();
            }
        }

        function updateUIForLoggedIn() {
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('flex');
            document.getElementById('userName').textContent = currentUser.nickname || 'User';
            
            if (currentUser.role === 'ADMIN') {
                document.getElementById('tab-admin').classList.remove('hidden');
            }
        }

        function connectWebSocket() {
            if (!currentUser) return;
            
            const wsUrl = `ws://localhost:8081/ws/notifications?userId=${currentUser.id}`;
            ws = new WebSocket(wsUrl);
            
            const statusDot = document.getElementById('wsStatusDot');
            const statusText = document.getElementById('wsStatusText');
            
            ws.onopen = () => {
                console.log('WS Connected');
                statusDot.classList.remove('bg-stone-300', 'bg-red-400');
                statusDot.classList.add('bg-green-400');
                statusText.textContent = 'Live';
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type !== 'CONNECTED') {
                        showNotification(data.message, data.type);
                    }
                } catch (e) {
                    if (event.data !== 'PONG') showNotification(event.data);
                }
            };
            
            ws.onclose = () => {
                console.log('WS Disconnected');
                statusDot.classList.remove('bg-green-400');
                statusDot.classList.add('bg-red-400');
                statusText.textContent = 'Offline';
                setTimeout(() => {
                    if (currentUser) connectWebSocket();
                }, 5000);
            };
            
            // Heartbeat
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) ws.send('PING');
            }, 30000);
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            if (ws) ws.close();
            
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('tab-admin').classList.add('hidden');
            
            switchTab('questions');
            showNotification('Successfully logged out');
        }

        // --- Notifications ---
        function showNotification(message, type = 'INFO') {
            const container = document.getElementById('notificationContainer');
            const toast = document.createElement('div');
            
            let iconName = 'info';
            let bgColor = 'bg-white/90';
            let textColor = 'text-stone-800';
            let borderColor = 'border-stone-200';
            
            if (type.includes('APPROVED')) {
                iconName = 'check-circle';
                bgColor = 'bg-emerald-50/90';
                textColor = 'text-emerald-900';
                borderColor = 'border-emerald-100';
            } else if (type.includes('REJECTED')) {
                iconName = 'x-circle';
                bgColor = 'bg-red-50/90';
                textColor = 'text-red-900';
                borderColor = 'border-red-100';
            } else if (type.includes('ANSWER')) {
                iconName = 'message-circle';
            }

            toast.className = `notification-toast pointer-events-auto flex items-center gap-3 px-6 py-4 rounded-2xl shadow-xl border ${borderColor} ${bgColor} ${textColor} min-w-[320px]`;
            toast.innerHTML = `
                <i data-lucide="${iconName}" class="w-5 h-5 opacity-80"></i>
                <span class="font-medium text-sm">${message}</span>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // --- Data Loading ---
        function getAuthHeaders() {
            const headers = {'Content-Type': 'application/json'};
            if (currentUser && currentUser.id) {
                headers['X-User-Id'] = currentUser.id.toString();
            }
            return headers;
        }

        async function loadQuestions() {
            try {
                const headers = {};
                if (currentUser && currentUser.id) {
                    headers['X-User-Id'] = currentUser.id.toString();
                }
                const response = await fetch(`${API_BASE}/api/questions`, { headers });
                const questions = await response.json();
                
                const container = document.getElementById('questionList');
                if (!questions || questions.length === 0) {
                    container.innerHTML = '<div class="text-center py-20 text-stone-400 font-light">No discussions yet. Be the first to start one.</div>';
                    return;
                }
                
                container.innerHTML = questions.map(q => `
                    <div class="card-hover bg-white rounded-2xl p-8 shadow-sm border border-stone-100 cursor-pointer group" onclick="showQuestionDetail(${q.id})">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-medium text-stone-900 group-hover:text-stone-600 transition-colors">${escapeHtml(q.title)}</h3>
                            ${getStatusBadge(q.status)}
                        </div>
                        <p class="text-stone-500 font-light line-clamp-2 mb-6 text-sm leading-relaxed">${escapeHtml(q.content)}</p>
                        <div class="flex items-center gap-4 text-xs font-medium text-stone-400 uppercase tracking-wide">
                            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${formatDate(q.createTime)}</span>
                        </div>
                    </div>
                `).join('');
                refreshIcons();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('questionList').innerHTML = 
                    '<div class="text-center py-20 text-stone-400">Unable to load discussions. Server might be offline.</div>';
            }
        }

        async function searchQuestions() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) return;
            
            try {
                const headers = {};
                if (currentUser && currentUser.id) {
                    headers['X-User-Id'] = currentUser.id.toString();
                }
                const response = await fetch(`${API_BASE}/search?keyword=${encodeURIComponent(keyword)}&page=1&size=20`, { headers });
                const data = await response.json();
                
                const container = document.getElementById('searchResults');
                if (!data.data || data.data.length === 0) {
                    container.innerHTML = '<div class="text-center py-20 text-stone-400 font-light">No results found matching your query.</div>';
                    return;
                }
                
                container.innerHTML = data.data.map(q => `
                    <div class="card-hover bg-white rounded-2xl p-8 shadow-sm border border-stone-100 cursor-pointer group" onclick="showQuestionDetail(${q.id})">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-medium text-stone-900 group-hover:text-stone-600 transition-colors">${escapeHtml(q.title)}</h3>
                            <span class="text-xs font-bold text-stone-300">SEARCH RESULT</span>
                        </div>
                        <p class="text-stone-500 font-light line-clamp-2 mb-4 text-sm">${escapeHtml(q.content)}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function showQuestionDetail(id) {
            try {
                currentQuestionId = id;
                const headers = {};
                if (currentUser && currentUser.id) {
                    headers['X-User-Id'] = currentUser.id.toString();
                }
                const response = await fetch(`${API_BASE}/api/questions/${id}`, { headers });
                if (!response.ok) throw new Error('Failed to load question');
                const question = await response.json();
                
                document.getElementById('detailTitle').textContent = question.title;
                document.getElementById('detailContent').textContent = question.content;
                document.getElementById('answerQuestionId').value = id;

                const adminActions = document.getElementById('detailAdminActions');
                if (currentUser && currentUser.role === 'ADMIN') {
                    adminActions.classList.remove('hidden');
                } else {
                    adminActions.classList.add('hidden');
                }
                
                await loadAnswers(id);
                showModal('questionDetailModal');
                refreshIcons();
            } catch (error) {
                console.error('Detail error:', error);
            }
        }

        async function loadAnswers(questionId) {
            try {
                const headers = {};
                if (currentUser && currentUser.id) {
                    headers['X-User-Id'] = currentUser.id.toString();
                }
                const response = await fetch(`${API_BASE}/api/answers/question/${questionId}`, { headers });
                const answers = await response.json();
                
                const container = document.getElementById('answerList');
                if (!answers || answers.length === 0) {
                    container.innerHTML = '<div class="text-stone-400 text-sm font-light italic">No responses yet.</div>';
                    return;
                }
                
                container.innerHTML = answers.map(a => `
                    <div class="relative bg-stone-50 rounded-2xl p-6 ${a.isBest ? 'ring-1 ring-emerald-500 bg-emerald-50/30' : ''}">
                        ${a.isBest ? '<div class="absolute -top-3 left-6 bg-emerald-500 text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> Top Answer</div>' : ''}
                        <p class="text-stone-700 leading-relaxed font-light">${escapeHtml(a.content)}</p>
                        <div class="mt-4 flex items-center justify-between">
                            <span class="text-xs text-stone-400">${formatDate(a.createTime)}</span>
                            ${getStatusBadge(a.status, true)}
                        </div>
                    </div>
                `).join('');
                refreshIcons();
            } catch (error) {
                console.error('Answers error:', error);
            }
        }

        async function loadPendingContent() {
            if (!currentUser || currentUser.role !== 'ADMIN') return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/content/pending`, {
                    headers: { 'X-User-Id': currentUser.id.toString() }
                });
                const data = await response.json();
                
                renderPendingItems('pendingQuestions', data.pendingQuestions, 'question');
                renderPendingItems('pendingAnswers', data.pendingAnswers, 'answer');
            } catch (error) {
                console.error('Admin load error:', error);
            }
        }

        function renderPendingItems(containerId, items, type) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) {
                container.innerHTML = `<div class="text-stone-400 text-sm font-light italic">No pending ${type}s</div>`;
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="bg-stone-50 rounded-xl p-5 border border-stone-200">
                    ${type === 'question' ? `<h4 class="font-medium text-stone-900 mb-2">${escapeHtml(item.title)}</h4>` : ''}
                    <p class="text-stone-600 text-sm font-light mb-4 line-clamp-3">${escapeHtml(item.content)}</p>
                    <div class="flex gap-2">
                        <button onclick="reviewContent('${type}s', ${item.id}, 'approve')" 
                            class="flex-1 bg-stone-900 text-white text-xs font-medium py-2 rounded-lg hover:bg-stone-700 transition-colors">Approve</button>
                        <button onclick="reviewContent('${type}s', ${item.id}, 'reject')" 
                            class="flex-1 bg-white border border-stone-200 text-stone-600 text-xs font-medium py-2 rounded-lg hover:bg-stone-100 transition-colors">Reject</button>
                        ${type === 'question' ? `<button onclick="deleteQuestion(${item.id})" 
                            class="flex-1 bg-red-600 text-white text-xs font-medium py-2 rounded-lg hover:bg-red-700 transition-colors">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // --- Actions ---
        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                // First login
                const loginRes = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, password })
                });
                const loginData = await loginRes.json();
                
                if (loginData.error) throw new Error(loginData.error);
                
                // Then get user details
                const userRes = await fetch(`${API_BASE}/api/users/email/${email}`);
                const userData = await userRes.json();
                
                currentUser = userData;
                currentUser.token = loginData.token;
                localStorage.setItem('user', JSON.stringify(currentUser));
                
                hideModal('loginModal');
                updateUIForLoggedIn();
                connectWebSocket();
                showNotification('Welcome back');
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        async function register(e) {
            e.preventDefault();
            const nickname = document.getElementById('registerNickname').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const res = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nickname, email, password, role: 'USER' })
                });
                const data = await res.json();
                
                if (!data.ok) throw new Error(data.error);
                
                hideModal('registerModal');
                showNotification('Account created successfully');
                showModal('loginModal');
                document.getElementById('loginEmail').value = email;
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        async function submitQuestion(e) {
            e.preventDefault();
            if (!currentUser) return showModal('loginModal');
            
            const title = document.getElementById('questionTitle').value;
            const content = document.getElementById('questionContent').value;
            
            try {
                const res = await fetch(`${API_BASE}/api/questions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-User-Id': currentUser.id.toString() },
                    body: JSON.stringify({ userId: currentUser.id, title, content })
                });
                const data = await res.json();
                
                if (data.ok) {
                    hideModal('askModal');
                    e.target.reset();
                    loadQuestions();
                    showNotification('Question published');
                }
            } catch (error) {
                console.error(error);
                alert('Failed to publish');
            }
        }

        async function submitAnswer(e) {
            e.preventDefault();
            if (!currentUser) return showModal('loginModal');
            
            const questionId = document.getElementById('answerQuestionId').value;
            const content = document.getElementById('answerContent').value;
            
            try {
                const res = await fetch(`${API_BASE}/api/answers`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ questionId: parseInt(questionId), userId: currentUser.id, content })
                });
                const data = await res.json();
                
                if (data.ok) {
                    hideModal('answerModal');
                    e.target.reset();
                    showNotification('Response submitted');
                    showQuestionDetail(questionId);
                }
            } catch (error) {
                console.error(error);
                alert('Failed to submit');
            }
        }

        async function reviewContent(type, id, action) {
            try {
                const res = await fetch(`${API_BASE}/api/admin/${type}/${id}/${action}`, {
                    method: 'POST',
                    headers: { 'X-Admin-Id': currentUser.id.toString() }
                });
                const data = await res.json();
                
                if (data.ok) {
                    showNotification(`${action === 'approve' ? 'Approved' : 'Rejected'} successfully`, 
                        action === 'approve' ? 'APPROVED' : 'REJECTED');
                    loadPendingContent();
                    loadQuestions();
                }
            } catch (error) {
                alert('Action failed');
            }
        }

        async function deleteQuestion(id) {
            if (!currentUser || currentUser.role !== 'ADMIN') return;
            if (!confirm('Delete this question? This cannot be undone.')) return;

            try {
                const res = await fetch(`${API_BASE}/api/admin/questions/${id}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Id': currentUser.id.toString() }
                });
                const data = await res.json();
                if (data.ok) {
                    showNotification('Question deleted', 'REJECTED');
                    loadPendingContent();
                    loadQuestions();
                    hideModal('questionDetailModal');
                } else {
                    alert('Delete failed');
                }
            } catch (error) {
                alert('Delete failed');
            }
        }

        function deleteCurrentQuestion() {
            const id = document.getElementById('answerQuestionId').value;
            if (!id) return;
            deleteQuestion(id);
        }

        // --- UI Helpers ---
        function switchTab(tabName) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('#tab-questions, #tab-search, #tab-admin').forEach(btn => {
                btn.classList.remove('bg-white', 'text-stone-900', 'shadow-sm');
                btn.classList.add('text-stone-500');
            });
            
            document.getElementById(`page-${tabName}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.remove('text-stone-500');
            activeBtn.classList.add('bg-white', 'text-stone-900', 'shadow-sm');
            
            if (tabName === 'admin') loadPendingContent();
        }

        function showModal(id) {
            const modal = document.getElementById(id);
            const overlay = document.getElementById('modalOverlay');
            
            overlay.classList.remove('hidden');
            modal.classList.remove('hidden');
            
            // Animation
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                modal.classList.remove('opacity-0', 'scale-95');
                modal.classList.add('opacity-100', 'scale-100');
            }, 10);
        }

        function hideModal(id) {
            const modal = document.getElementById(id);
            const overlay = document.getElementById('modalOverlay');
            
            // Animation
            modal.classList.remove('opacity-100', 'scale-100');
            modal.classList.add('opacity-0', 'scale-95');
            overlay.classList.add('opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                overlay.classList.add('hidden');
            }, 300);
        }

        function closeAllModals() {
            document.querySelectorAll('[id$="Modal"]').forEach(modal => {
                if (!modal.classList.contains('hidden')) {
                    hideModal(modal.id);
                }
            });
        }
        
        function showAnswerModal() {
            if (!currentUser) {
                showNotification('Please login to reply', 'INFO');
                showModal('loginModal');
                return;
            }
            hideModal('questionDetailModal');
            showModal('answerModal');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
        }

        function getStatusBadge(status, small = false) {
            let color = 'bg-stone-100 text-stone-500';
            let icon = 'clock';
            let text = 'Pending';
            
            if (status === 'APPROVED') {
                color = 'bg-emerald-50 text-emerald-600';
                icon = 'check-circle';
                text = 'Approved';
            } else if (status === 'REJECTED') {
                color = 'bg-red-50 text-red-600';
                icon = 'x-circle';
                text = 'Rejected';
            }
            
            const px = small ? 'px-2 py-0.5' : 'px-3 py-1';
            const textSize = small ? 'text-[10px]' : 'text-xs';
            
            return `
                <span class="${color} ${px} rounded-full ${textSize} font-medium uppercase tracking-wider flex items-center gap-1.5">
                    <i data-lucide="${icon}" class="${small ? 'w-3 h-3' : 'w-3.5 h-3.5'}"></i>
                    ${text}
                </span>
            `;
        }
    </script>
</body>
</html>
